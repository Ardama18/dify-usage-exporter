---
id: 4
feature: external-api-sender
type: adr
version: 1.0.0
created: 2025-11-18
based_on: specs/stories/4-external-api-sender/prd.md
---

# ADR 001: スプールファイル形式

## ステータス

Accepted

## コンテキスト

外部API送信失敗時に、データをローカルファイルシステムに永続化（スプール保存）し、次回実行時に自動再送する機構が必要である。スプールファイルの形式は、以下の要件を満たす必要がある：

- **データ完全性**: バッチ全体を確実に保存・復元できること
- **冪等性の保証**: バッチ単位での冪等性を保証しやすい形式であること
- **パフォーマンス**: ファイル読み書きのオーバーヘッドが少ないこと
- **ディスク効率**: ファイル数を抑え、ディレクトリ走査を高速化すること
- **運用性**: 手動確認・デバッグが容易であること

現在の設計では、バッチサイズは100件/バッチで管理される。バッチ全体で冪等性を保証するため、バッチ単位での保存か、レコード単位での保存かを選択する必要がある。

## 決定事項

**1 JSONファイル形式（バッチ全体を1ファイルに保存）を採用する。**

スプールファイルの構造：
```json
{
  "batchIdempotencyKey": "a3f2e1b9c4d5...",
  "records": [...],
  "firstAttempt": "2025-01-18T12:05:30Z",
  "retryCount": 0,
  "lastError": "HTTP 503 Service Unavailable"
}
```

ファイル名: `spool_{timestamp}_{batchIdempotencyKey}.json`
- 例: `spool_20250118T120530Z_a3f2e1b9c4d5.json`

## 根拠

### 検討した選択肢

#### 1. JSON Lines形式（1行1レコード）
- **説明**: 1バッチ内の各レコードを1行ずつJSON形式で保存（NDJSON形式）
- **利点**:
  - レコード単位での部分再送が可能（1件だけ失敗した場合に効率的）
  - ストリーミング処理に適している（メモリ効率が高い）
  - 大量データ（1000件超）でもメモリ使用量を抑制できる
  - ログ形式と親和性が高い（構造化ログと同じ形式）
- **欠点**:
  - バッチ単位の冪等性保証が複雑になる（どのレコードが送信済みかの管理が必要）
  - ファイルフォーマットが冗長になる（メタデータを各行に含める必要がある）
  - 再送時にバッチ全体を再構築する処理が必要
  - 部分送信時の整合性確保が難しい（外部APIがバッチ全体を期待する場合）

#### 2. 1 JSONファイル（バッチ全体）（採用）
- **説明**: バッチ全体を1つのJSONファイルとして保存
- **利点**:
  - バッチ単位の冪等性保証が容易（batchIdempotencyKeyで一意に識別）
  - ファイル数が少ない（ディレクトリ走査が高速）
  - バッチサイズ100件/バッチで管理可能な範囲
  - 外部APIへの送信時にそのまま使える（再変換不要）
  - メタデータ（firstAttempt、retryCount）をファイル全体で1回記録すれば良い
  - シンプルな実装（JSONパース・シリアライズのみ）
- **欠点**:
  - 1件だけ失敗した場合も、バッチ全体を再送する必要がある
  - バッチサイズが大きい場合（1000件超）はメモリ使用量が増加
  - 部分再送ができない（柔軟性が低い）

#### 3. 複数JSONファイル（レコード単位）
- **説明**: 各レコードを個別のJSONファイルとして保存
- **利点**:
  - レコード単位での細かい制御が可能
  - 1件だけ失敗した場合に効率的に再送できる
  - ファイルごとに独立して処理できる（並列処理に適している）
- **欠点**:
  - ファイル数が膨大になる（100件/バッチ × 複数バッチ = 数千ファイル）
  - ディレクトリ走査のパフォーマンスが著しく低下
  - バッチ単位の冪等性保証が非常に複雑になる
  - ファイルシステムのinode制限に引っかかる可能性
  - 運用時の手動確認が困難（ファイルが多すぎる）

### 選択理由

**1 JSONファイル形式（バッチ全体）を選択した理由:**

1. **冪等性の保証のしやすさ（最優先）**
   - 外部APIが409 Conflictを返す仕様のため、バッチ単位で冪等性を保証する必要がある
   - batchIdempotencyKeyでバッチ全体を一意に識別できる
   - 部分送信による不整合を防ぐ（バッチの一部だけが送信済みの状態を避ける）

2. **ファイル数の削減（パフォーマンス）**
   - 1バッチ = 1ファイルなので、ディレクトリ走査が高速
   - 1日10バッチ × 7日間 = 最大70ファイル程度（管理可能な範囲）
   - ファイルシステムのinode制限を回避

3. **バッチサイズが管理可能**
   - 100件/バッチは現実的なサイズ（1ファイル約100KB-1MB程度）
   - メモリ使用量は50MB以内に抑制可能（非機能要件を満たす）
   - Node.jsのJSON.parse/stringifyで十分に処理できる

4. **シンプルな実装**
   - 標準のJSON操作のみで実装可能
   - メタデータの重複がない（ファイル全体で1回記録）
   - 再送時の処理が単純（ファイルを読んでそのまま送信）

5. **外部APIとの親和性**
   - 外部APIはバッチ全体を受け取る仕様のため、そのまま送信できる
   - 再変換・再構築の処理が不要

### トレードオフの受容

**受け入れるトレードオフ:**
- 1件だけ失敗した場合も、バッチ全体を再送する必要がある
  - **軽減策**: 外部APIが冪等性を保証（409レスポンス）するため、重複送信は安全
  - **判断**: バッチサイズが100件程度なので、全体再送のオーバーヘッドは許容範囲

- JSON Linesのようなストリーミング処理ができない
  - **軽減策**: バッチサイズを100件に制限し、メモリ使用量を50MB以内に抑制
  - **判断**: 現在の要件では大量データ処理は不要、YAGNI原則を適用

## 影響

### ポジティブな影響

- **冪等性の保証が確実**: バッチ単位での一意識別により、重複送信を確実に防止
- **パフォーマンスの向上**: ファイル数削減によりディレクトリ走査が高速化
- **実装の簡素化**: 標準のJSON操作のみで実装でき、複雑なストリーミング処理が不要
- **デバッグの容易さ**: 1ファイルでバッチ全体を確認でき、手動調査が容易
- **運用負荷の軽減**: ファイル数が少ないため、手動削除・確認が容易

### ネガティブな影響

- **部分再送の非効率**: 1件だけ失敗しても、バッチ全体を再送する必要がある
- **メモリ使用量**: バッチ全体をメモリに展開する必要があるが、100件/バッチなら許容範囲
- **柔軟性の制限**: 将来的に大量データ処理（1000件超/バッチ）が必要になった場合、JSON Linesへの移行が必要

### 中立的な影響

- **ファイルサイズ**: 1ファイルあたり約100KB-1MB（100件/バッチ想定）
- **スプール保持期間**: 7日間で最大70ファイル程度（1日10バッチ想定）

## 実装への指針

### 原則

1. **ファイル操作は原子性を保証**
   - ファイル書き込み時は一時ファイルを使用し、完了後にリネーム（atomic operation）
   - ファイル読み込み時は破損を検出し、エラーハンドリング

2. **zodによるバリデーション**
   - スプールファイル読み込み時に、zodスキーマで構造を検証
   - 破損ファイルは`data/failed/`へ移動し、エラー通知

3. **ファイルパーミッション600**
   - スプールファイルは所有者のみ読み書き可能（セキュリティ要件）

4. **タイムスタンプはISO 8601形式**
   - firstAttemptはUTC時刻（`2025-01-18T12:05:30Z`形式）

5. **メタデータの正確な記録**
   - retryCount、lastError、firstAttemptを確実に記録・更新

## 参考資料

- [Idempotency Keys in REST APIs (Zuplo, 2025)](https://zuplo.com/learning-center/implementing-idempotency-keys-in-rest-apis-a-complete-guide) - 冪等性キーの設計パターン
- [Stripe API Idempotent Requests](https://docs.stripe.com/api/idempotent_requests) - バッチ単位の冪等性保証の実例
- [NDJSON Specification](http://ndjson.org/) - JSON Lines形式の仕様（選択肢1の参考）

## 関連情報

- Epic方針書: `specs/epics/1-dify-usage-exporter/epic.md`
- PRD: `specs/stories/4-external-api-sender/prd.md`
- 関連ADR:
  - ADR 002: リトライポリシー（スプール保存のトリガー条件）
  - ADR 006: スプール保持期間とリトライ上限（スプールファイルのライフサイクル）
