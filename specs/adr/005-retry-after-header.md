---
id: 4
feature: external-api-sender
type: adr
version: 1.0.0
created: 2025-11-18
based_on: specs/stories/4-external-api-sender/prd.md
---

# ADR 005: Retry-Afterヘッダ対応

## ステータス

Accepted

## コンテキスト

HTTP 429（Too Many Requests）レスポンスを受信した際、サーバーは`Retry-After`ヘッダで推奨待機時間を指定する場合がある。リトライポリシーを実装する際、以下の2つのアプローチが考えられる：

1. **Retry-Afterヘッダを考慮**: サーバー指定の待機時間を優先（動的バックオフ）
2. **指数バックオフのみ**: 固定間隔のバックオフ（サーバー指示を無視）

現在の要件では、実装コストと効果のバランスを考慮する必要がある。

## 決定事項

**指数バックオフのみ（固定間隔）を採用し、Retry-Afterヘッダは無視する。**

- **リトライ間隔**: 指数バックオフ（1秒 → 2秒 → 4秒、固定）
- **Retry-Afterヘッダ**: 無視（パースしない）
- **将来拡張**: 必要になれば実装可能（インターフェース変更不要）

## 根拠

### 検討した選択肢

#### 1. Retry-Afterヘッダを考慮（動的バックオフ）
- **説明**: 429レスポンスの`Retry-After`ヘッダを優先し、指定された時間待機
- **利点**:
  - サーバー側の推奨待機時間を尊重（最適な待機時間）
  - レート制限ウィンドウのリセットタイミングに合わせられる
  - 過剰な待機時間を避けられる（サーバーが短い待機時間を指定した場合）
  - HTTP標準に準拠（RFC 7231）
- **欠点**:
  - 実装コストが高い（ヘッダのパース、秒数/日時形式の両対応）
  - 429レスポンスでも`Retry-After`ヘッダがない場合が多い（実際の外部API）
  - サーバー側の指定が不適切な場合のフォールバック処理が必要
  - テストケースが複雑化（ヘッダあり/なし、秒数/日時形式）
  - デバッグが困難（待機時間が動的に変わる）

#### 2. 指数バックオフのみ（固定間隔）（採用）
- **説明**: `Retry-After`ヘッダを無視し、常に指数バックオフ（1秒 → 2秒 → 4秒）
- **利点**:
  - 実装が非常にシンプル（axios-retryのデフォルト挙動）
  - 挙動が予測可能（デバッグが容易）
  - テストケースが単純（固定間隔のみ）
  - 指数バックオフで十分な待機時間を確保（レート制限の大半に対応）
  - 実装コスト削減（開発期間短縮）
- **欠点**:
  - `Retry-After`ヘッダを無視（サーバー側の推奨待機時間を尊重しない）
  - サーバーが短い待機時間を指定した場合、過剰に待機する可能性
  - HTTP標準に完全には準拠しない

### 選択理由

**指数バックオフのみを選択した理由:**

1. **実装コストと効果のバランス（最優先）**
   - `Retry-After`ヘッダ対応の実装コストは高い（ヘッダパース、形式変換、フォールバック）
   - 実際の外部APIで`Retry-After`ヘッダがある場合は少ない（AWS API Gateway、CloudFlareでも省略される場合が多い）
   - 指数バックオフで十分な効果が得られる（業界標準のアプローチ）

2. **シンプル性優先（YAGNI原則）**
   - 現時点で`Retry-After`ヘッダの必要性が不明確
   - 将来的に必要になった場合、その時点で実装を追加可能
   - 過剰設計を避け、現在の要件に集中

3. **指数バックオフの十分性**
   - 1秒 → 2秒 → 4秒の待機時間は、ほとんどのレート制限に対応
   - AWS API Gateway: 1秒あたり10,000リクエスト（指数バックオフで十分）
   - CloudFlare: 1分あたり600リクエスト（指数バックオフで十分）
   - 一般的なレート制限（1分間に100リクエスト等）にも対応

4. **予測可能な挙動**
   - 固定間隔のため、デバッグが容易
   - テストケースが単純（リトライ回数と待機時間が固定）
   - ログから挙動を容易に追跡できる

5. **将来の拡張余地**
   - axios-retryの`retryDelay`関数をカスタマイズすれば、`Retry-After`ヘッダ対応を追加可能
   - インターフェース変更不要（既存コードへの影響最小）

### トレードオフの受容

**受け入れるトレードオフ:**
- `Retry-After`ヘッダを無視する（サーバー側の推奨待機時間を尊重しない）
  - **軽減策**: 指数バックオフで十分な待機時間を確保（1秒 → 2秒 → 4秒）
  - **判断**: 実装コストと効果のバランスを考慮し、現時点では不要

- サーバーが短い待機時間を指定した場合、過剰に待機する可能性
  - **軽減策**: リトライ上限3回で総待機時間7秒（許容範囲）
  - **判断**: 非機能要件（P95 < 5秒）に適合、過剰待機のリスクは低い

- HTTP標準に完全には準拠しない
  - **軽減策**: 将来的に必要になれば実装を追加
  - **判断**: 現時点での準拠は優先度が低い

## 影響

### ポジティブな影響

- **実装の簡素化**: axios-retryのデフォルト挙動で十分、追加実装不要
- **開発期間の短縮**: `Retry-After`ヘッダ対応の実装コスト削減
- **デバッグの容易さ**: 固定間隔のため、挙動が予測可能
- **テストの簡素化**: テストケースが単純（固定間隔のみ）
- **保守性の向上**: コードがシンプルで、メンテナンスが容易

### ネガティブな影響

- **サーバー推奨待機時間の無視**: `Retry-After`ヘッダを無視し、固定バックオフのみ
- **過剰待機の可能性**: サーバーが短い待機時間を指定した場合、過剰に待機
- **HTTP標準非準拠**: `Retry-After`ヘッダを尊重しない

### 中立的な影響

- **将来の拡張**: 必要になれば`Retry-After`ヘッダ対応を追加可能
- **ログ出力**: 429レスポンス時に`Retry-After`ヘッダの有無をログに記録（将来の判断材料）

## 実装への指針

### 原則

1. **axios-retryのデフォルト挙動を使用**
   - `exponentialDelay`関数を使用
   - `Retry-After`ヘッダのパース処理は実装しない

2. **429レスポンスのログ出力**
   - 429レスポンス受信時、レスポンスヘッダをログに記録
   - `Retry-After`ヘッダの有無を確認（将来の判断材料）

3. **将来の拡張余地**
   - `retryDelay`関数をカスタマイズすれば、`Retry-After`ヘッダ対応を追加可能
   - インターフェース変更不要

4. **ドキュメント化**
   - ADRで決定事項を記録（`Retry-After`ヘッダを無視する理由）
   - 将来の拡張方針を明記

## 参考資料

- [RFC 7231: Retry-After Header](https://datatracker.ietf.org/doc/html/rfc7231#section-7.1.3) - HTTP標準仕様
- [Axios Retry Best Practices (ZenRows, 2025)](https://www.zenrows.com/blog/axios-retry) - 指数バックオフの実装パターン
- [AWS API Gateway Throttling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-request-throttling.html) - レート制限の実例

## 関連情報

- Epic方針書: `specs/epics/1-dify-usage-exporter/epic.md`
- PRD: `specs/stories/4-external-api-sender/prd.md`
- 関連ADR:
  - ADR 002: リトライポリシー（指数バックオフの詳細）
  - ADR 007: HTTPクライアントライブラリ（axios-retryの選定理由）
