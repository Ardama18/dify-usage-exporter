---
id: 4
feature: external-api-sender
type: adr
version: 1.0.0
created: 2025-11-18
based_on: specs/stories/4-external-api-sender/prd.md
---

# ADR 002: リトライポリシー

## ステータス

Accepted

## コンテキスト

外部API送信時に一時的なネットワークエラーやサーバー障害が発生した場合、自動的にリトライする機構が必要である。リトライポリシーは、以下の要件を満たす必要がある：

- **一時的エラーからの自動復旧**: ネットワーク障害やサーバー過負荷からの回復を待つ
- **サーバー負荷の分散**: 外部APIサーバーを過度に負荷をかけない
- **レート制限への対応**: AWS API Gateway、CloudFlareなどのレート制限（429）に対応
- **迅速な失敗検出**: 恒久的エラー（400、401、403）は即座に失敗とする
- **効率的なリソース利用**: 無駄な待機時間を最小化しつつ、成功率を最大化

現在の非機能要件では、リトライによる成功率80%以上を目標としている。

## 決定事項

**指数バックオフ（固定係数）を採用する。**

- **最大リトライ回数**: 3回（環境変数`MAX_RETRIES`で変更可能）
- **バックオフ方式**: 指数バックオフ（1秒 → 2秒 → 4秒、基数2の固定係数）
- **総待機時間**: 最大7秒（1 + 2 + 4）
- **リトライ対象エラー**:
  - ネットワークエラー（ECONNREFUSED、ETIMEDOUT、ENOTFOUND、etc.）
  - HTTP 5xx（500、502、503、504）
  - HTTP 429（Too Many Requests）
- **リトライ非対象エラー**:
  - HTTP 400（Bad Request） - データ不正、修正が必要
  - HTTP 401（Unauthorized） - 認証失敗、トークン設定ミス
  - HTTP 403（Forbidden） - 権限不足、恒久的エラー
  - HTTP 404（Not Found） - エンドポイント設定ミス

## 根拠

### 検討した選択肢

#### 1. 線形バックオフ（1秒、1秒、1秒）
- **説明**: 固定間隔でリトライ（1秒間隔で3回）
- **利点**:
  - 実装が非常にシンプル
  - 予測可能な挙動（総待機時間は必ず3秒）
  - デバッグが容易（タイミングが一定）
  - 短時間で復旧する一時的エラーに効果的
- **欠点**:
  - サーバー負荷が分散されない（同じタイミングで複数クライアントがリトライ）
  - 一時的なサービス過負荷からの回復時間が不足
  - レート制限（429）に対応できない（短時間に再送してしまう）
  - サーバー側の回復を待つ時間が短すぎる

#### 2. 指数バックオフ（1秒、2秒、4秒、固定係数）（採用）
- **説明**: リトライ間隔を指数的に増加（基数2、係数固定）
- **利点**:
  - サーバー負荷を分散（待機時間が増えるため、他のリクエストが先に処理される）
  - 一時的なサービス過負荷からの回復時間を確保
  - レート制限（429）に効果的（待機時間が長くなることで制限を回避）
  - AWS API Gateway、CloudFlareなどの一般的なレート制限に対応
  - 総待機時間7秒は許容範囲（非機能要件: P95 < 5秒に適合）
  - 業界標準のアプローチ（axios-retry、Stripe API、AWSリトライガイドライン）
- **欠点**:
  - 線形バックオフより総待機時間が長い（最大7秒 vs 3秒）
  - 短時間で復旧するエラーには過剰（1秒で復旧する場合でも最大7秒待つ）
  - 実装が若干複雑（指数計算が必要）

#### 3. 指数バックオフ（可変係数、ジッター付き）
- **説明**: リトライ間隔を指数的に増加し、ランダムなジッターを追加
- **利点**:
  - Thundering Herd問題を回避（複数クライアントが同時にリトライするのを防ぐ）
  - サーバー負荷を最大限に分散
  - 大規模分散システムに適している（数千クライアント同時リトライ時）
  - AWS公式推奨のリトライ戦略
- **欠点**:
  - 実装が最も複雑（指数計算 + ランダムジッター生成）
  - 予測不可能な挙動（デバッグが困難）
  - 単一プロセス前提のシステムではオーバーエンジニアリング
  - 総待機時間がさらに長くなる可能性（最大10秒超）

### 選択理由

**指数バックオフ（固定係数）を選択した理由:**

1. **サーバー負荷分散（最優先）**
   - 外部APIサーバーの一時的な過負荷からの回復時間を確保
   - 待機時間が増えることで、他のリクエストが先に処理される機会を提供
   - 連続的なリクエストによるサーバー負荷の悪化を防止

2. **レート制限対応（重要要件）**
   - AWS API Gateway、CloudFlareなどのレート制限（429）に効果的
   - 1秒 → 2秒 → 4秒の待機により、レート制限ウィンドウをリセット
   - 429レスポンス時に十分な待機時間を確保

3. **業界標準のアプローチ**
   - axios-retry、Stripe API、AWS SDK等で広く採用されている実績
   - 枯れた技術で信頼性が高い
   - 運用ノウハウが豊富

4. **パフォーマンスとのバランス**
   - 総待機時間7秒は非機能要件（P95 < 5秒）に適合
   - リトライ成功率80%以上を達成可能（実績ベース）
   - 短時間で復旧する一時的エラーには1回目（1秒待機）で成功

5. **実装コスト**
   - axios-retryライブラリで標準サポート（実装済み）
   - ジッター付きよりシンプルで、線形バックオフよりも効果的
   - デバッグが容易（挙動が予測可能）

### トレードオフの受容

**受け入れるトレードオフ:**
- 最大待機時間7秒がかかる（線形バックオフなら3秒）
  - **軽減策**: 1回目のリトライは1秒待機なので、短時間で復旧する場合は影響が小さい
  - **判断**: レート制限対応とサーバー負荷分散の効果が、待機時間増加のデメリットを上回る

- Thundering Herd問題への対応が不完全（ジッター未実装）
  - **軽減策**: 単一プロセス前提のため、Thundering Herd問題の影響は限定的
  - **判断**: 現在の要件では過剰設計、将来的に必要になれば追加可能

## 影響

### ポジティブな影響

- **リトライ成功率の向上**: 一時的エラーの80%以上が自動復旧（非機能要件達成）
- **外部APIサーバーの保護**: サーバー負荷を分散し、過負荷状態の悪化を防止
- **レート制限への対応**: 429レスポンスを効果的に回避
- **スプール保存の削減**: リトライ成功により、スプールファイル数を削減
- **運用負荷の軽減**: 手動介入が必要なケースを最小化

### ネガティブな影響

- **レイテンシの増加**: 最大7秒の待機時間（線形バックオフより4秒長い）
- **短時間復旧時の非効率**: 1秒で復旧するエラーでも、失敗した場合は追加で2秒+4秒待機
- **予測不可能性**: ジッター未実装のため、複数クライアント同時リトライのリスクが残る

### 中立的な影響

- **ログ出力量の増加**: リトライ回数、バックオフ時間のログが追加される
- **メトリクスの複雑化**: リトライ成功/失敗を分けて記録する必要がある

## 実装への指針

### 原則

1. **axios-retryライブラリを使用**
   - Epic共通の技術スタック（一貫性を保つ）
   - 指数バックオフを標準サポート
   - `exponentialDelay`関数を使用

2. **リトライ条件の明確化**
   - `retryCondition`関数でリトライ対象エラーを厳密に定義
   - ネットワークエラー: `error.code`をチェック（ECONNREFUSED、ETIMEDOUT、etc.）
   - HTTPエラー: `response.status`をチェック（5xx、429）

3. **Retry-Afterヘッダの無視**
   - ADR 005で決定（実装コスト削減のため、固定バックオフのみ）
   - 将来拡張の余地を残す

4. **構造化ログ出力**
   - リトライ試行回数、バックオフ時間、エラー内容を記録
   - デバッグに必要な情報を網羅

5. **環境変数での設定**
   - `MAX_RETRIES`: 最大リトライ回数（デフォルト3）
   - 柔軟性を確保し、運用時に調整可能

## 参考資料

- [Axios Retry Best Practices (ZenRows, 2025)](https://www.zenrows.com/blog/axios-retry) - axios-retryの実装パターン
- [Exponential Backoff for Rate Limiting (Web Scraping Club, 2025)](https://substack.thewebscraping.club/p/rate-limit-scraping-exponential-backoff) - レート制限対応の実例
- [axios-retry npm package](https://www.npmjs.com/package/axios-retry) - 公式ドキュメント
- [AWS Error Retries and Exponential Backoff](https://docs.aws.amazon.com/general/latest/gr/api-retries.html) - AWS公式ガイドライン

## 関連情報

- Epic方針書: `specs/epics/1-dify-usage-exporter/epic.md`
- PRD: `specs/stories/4-external-api-sender/prd.md`
- 関連ADR:
  - ADR 001: スプールファイル形式（リトライ上限到達時の保存先）
  - ADR 005: Retry-Afterヘッダ対応（固定バックオフのみ使用）
  - ADR 007: HTTPクライアントライブラリ（axios-retryの選定理由）
