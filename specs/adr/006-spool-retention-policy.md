---
id: 4
feature: external-api-sender
type: adr
version: 1.0.0
created: 2025-11-18
based_on: specs/stories/4-external-api-sender/prd.md
---

# ADR 006: スプール保持期間とリトライ上限

## ステータス

Accepted

## コンテキスト

スプールファイル（`data/spool/`）に保存されたデータは、次回実行時に自動的に再送される。スプールファイルの保持期間とリトライ上限を適切に設定する必要がある。以下の要件を考慮する：

- **データ完全性**: 一時的な障害からの復旧を待つ
- **ディスク容量管理**: スプールファイルの肥大化を防ぐ
- **運用負荷**: 手動介入が必要なケースを最小化
- **長期障害への対応**: 7日間を超える障害時の対処

現在の設計では、1時間ごとに実行され、1日あたり最大24回のリトライチャンスがある。

## 決定事項

**保持期間7日、リトライ上限10回を採用する。**

- **スプール保持期間**: 7日間（firstAttemptから168時間）
- **スプールリトライ上限**: 10回（retryCount ≥ 10で`data/failed/`へ移動）
- **実行頻度**: 1時間ごと（最大168回のリトライチャンス）
- **超過時の対応**: `data/failed/`へ移動し、エラー通知送信

## 根拠

### 検討した選択肢

#### 1. 保持期間7日、リトライ上限10回（採用）
- **説明**: 7日間保持し、10回リトライで`data/failed/`へ移動
- **利点**:
  - **7日間でほとんどの一時障害は回復**: AWS SLA 99.9%（月間障害時間43分）、週末障害も対応可能
  - **ディスク容量とのバランス**: 1日10バッチ × 7日間 = 最大70ファイル（約70MB-700MB）
  - **168回のリトライチャンス**: 1時間ごと × 7日間 = 168回（十分な再送機会）
  - **10回で手動介入促進**: 10時間（最短）で`data/failed/`移動、早期の手動対応を促す
  - **運用負荷のバランス**: 自動復旧と手動介入の適切なバランス
- **欠点**:
  - 7日間を超える長期障害ではデータロス（`data/failed/`へ移動後、手動対応が必要）
  - リトライ上限10回は若干早い（168回中10回のみ）

#### 2. 保持期間14日、リトライ上限20回
- **説明**: 14日間保持し、20回リトライで`data/failed/`へ移動
- **利点**:
  - より長期の障害に対応可能（14日間）
  - リトライチャンスが多い（336回中20回）
  - より慎重な自動復旧戦略
- **欠点**:
  - ディスク容量の増加（14日間 × 10バッチ/日 = 最大140ファイル、約1.4GB）
  - 手動介入のタイミングが遅れる（最短20時間）
  - スプールファイルの肥大化リスク
  - 14日間の障害は稀（AWS SLA 99.9%を大きく下回る）

#### 3. 無制限保持、手動削除
- **説明**: 保持期間無制限、手動でスプールファイルを削除
- **利点**:
  - データロスのリスクがゼロ（永久保存）
  - 長期障害でも自動復旧可能
  - 柔軟な運用（手動で削除タイミングを決定）
- **欠点**:
  - ディスク容量が無制限に増加（運用負荷が高い）
  - スプールファイルの肥大化で走査パフォーマンスが低下
  - 手動削除が必須（自動化されていない）
  - 運用ミスによるディスク容量不足のリスク

### 選択理由

**保持期間7日、リトライ上限10回を選択した理由:**

1. **7日間でほとんどの一時障害は回復（最優先）**
   - AWS SLA 99.9%（月間障害時間43分、週間障害時間10分程度）
   - 7日間あれば、ほとんどの一時的な障害（ネットワーク、サーバー過負荷、計画メンテナンス）は回復
   - 週末を含む障害にも対応可能（金曜夜 → 月曜朝）

2. **ディスク容量とのバランス**
   - 1日10バッチ × 7日間 = 最大70ファイル（約70MB-700MB、1ファイル1-10MB想定）
   - ディスク容量1GB未満で管理可能
   - ファイル数70個程度なら、ディレクトリ走査のパフォーマンス低下なし

3. **168回のリトライチャンス**
   - 1時間ごと × 7日間 = 168回のリトライチャンス
   - リトライ上限10回でも、168回中10回（約6%）しか使わない
   - 残りの158回は自動復旧の余地

4. **10回で手動介入促進**
   - リトライ10回 = 最短10時間で`data/failed/`移動
   - 早期に手動対応を促し、長期障害の早期発見
   - 運用チームが問題を認識しやすい

5. **運用負荷のバランス**
   - 自動復旧（7日間、168回チャンス）と手動介入（10回で通知）の適切なバランス
   - 手動介入が必要なケースは稀（外部APIの長期停止、設定ミス等）

### トレードオフの受容

**受け入れるトレードオフ:**
- 7日間を超える長期障害ではデータロス
  - **軽減策**: `data/failed/`へ移動後、手動で再送可能（Story 6でCLI提供）
  - **判断**: 7日間を超える障害は極めて稀、SLA 99.9%を大きく下回る

- リトライ上限10回は若干早い（168回中10回のみ）
  - **軽減策**: 環境変数`MAX_SPOOL_RETRIES`で調整可能
  - **判断**: 早期の手動介入促進を優先、運用で調整可能

- ディスク容量の制限（7日間で約700MB上限）
  - **軽減策**: 定期的な`data/failed/`クリーンアップ手順を運用手順書に記載
  - **判断**: 1GB未満で管理可能、現実的な制約

## 影響

### ポジティブな影響

- **高い自動復旧率**: 7日間、168回のリトライチャンスで一時的障害のほとんどが自動復旧
- **ディスク容量管理**: 7日間で最大700MB程度、管理可能な範囲
- **早期の手動介入**: 10回で`data/failed/`移動、長期障害の早期発見
- **運用負荷のバランス**: 自動復旧と手動介入の適切なバランス
- **柔軟性**: 環境変数で保持期間とリトライ上限を調整可能

### ネガティブな影響

- **7日間超の長期障害**: `data/failed/`へ移動後、手動対応が必要
- **リトライ上限の早さ**: 10回（10時間）で`data/failed/`移動、若干早い可能性
- **ディスク容量制約**: 7日間で約700MB上限

### 中立的な影響

- **スプールファイルのライフサイクル**: `data/spool/`（7日間） → `data/failed/`（永久保存）
- **手動対応の必要性**: `data/failed/`へ移動後、CLI（Story 6）で手動再送

## 実装への指針

### 原則

1. **firstAttemptの記録**
   - スプールファイル作成時に`firstAttempt`（ISO 8601形式）を記録
   - 保持期間判定に使用

2. **retryCountのインクリメント**
   - 再送失敗時に`retryCount`をインクリメント
   - リトライ上限判定に使用

3. **スプールファイルの走査**
   - 毎回実行時に`data/spool/`を走査
   - firstAttempt昇順でソート（古いデータ優先）

4. **保持期間とリトライ上限の判定**
   ```typescript
   // 保持期間チェック（7日間）
   const isExpired = (new Date() - new Date(firstAttempt)) > 7 * 24 * 60 * 60 * 1000

   // リトライ上限チェック（10回）
   const isMaxRetries = retryCount >= MAX_SPOOL_RETRIES
   ```

5. **data/failed/への移動**
   - `isExpired || isMaxRetries`の場合、`data/failed/`へ移動
   - エラー通知送信（INotifier）

6. **環境変数での設定**
   - `MAX_SPOOL_RETRIES`: リトライ上限（デフォルト10）
   - 柔軟性を確保し、運用時に調整可能

## 参考資料

- [AWS SLA 99.9%](https://aws.amazon.com/compute/sla/) - 月間障害時間43分
- [Best Practices for Message Queue Services (ResearchGate, 2025)](https://www.researchgate.net/publication/387722154_BEST_PRACTICES_FOR_MESSAGE_QUEUE_SERVICES_IN_DISTRIBUTED_SYSTEMSRaghukishore_Balivada) - スプールファイル管理のベストプラクティス

## 関連情報

- Epic方針書: `specs/epics/1-dify-usage-exporter/epic.md`
- PRD: `specs/stories/4-external-api-sender/prd.md`
- 関連ADR:
  - ADR 001: スプールファイル形式（スプールファイルの構造）
  - ADR 002: リトライポリシー（スプール保存のトリガー条件）
  - ADR 003: ファイルロック機構（スプールファイルのアクセス制御）
