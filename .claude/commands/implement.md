---
description: オーケストレーターとして要件分析から実装まで完全サイクルを管理
---
**コマンドコンテキスト**: 実装の完全サイクル管理（要件分析→設計→計画→実装→品質保証）

ultrathink

## 初回必須タスク

作業開始前に以下のルールファイルを必ず読み込み、厳守してください：
- @.claude/steering/core-principles.md - 全エージェント共通原則（タスク管理、品質基準、エラー対応）
- @.claude/steering/sub-agents.md - サブエージェント管理フロー

## 入力形式

```
/implement <ストーリーURL> [追加指示]
```
または
```
/implement [機能説明と追加指示]
```

**引数**：
- `<ストーリーURL>` (任意): NotionストーリーページのURL
- `[追加指示]` (任意): ユーザーからの追加要望・制約・方針

## 実行判断フロー

### 1. 現在状況の判定
指示内容: $ARGUMENTS

現在の状況を判定：

| 状況パターン | 判定基準 | 次のアクション |
|------------|---------|-------------|
| 新規ストーリー（ストーリーURL付き） | ストーリーURLが指定されている | notion-client(fetch_story)→ストーリー情報取得→meta.json生成→requirement-analyzerから開始（Notion情報+追加指示を含む） |
| 新規要件（ストーリーURLなし） | 既存作業なし、新しい機能/修正依頼 | requirement-analyzerから開始（機能説明+追加指示を含む） |
| フロー継続 | 既存ドキュメント/タスクあり、継続指示 | sub-agents.mdのフローで次のステップを特定 |
| 品質エラー | エラー検出、テスト失敗、ビルドエラー | quality-fixer実行 |
| 不明瞭 | 意図が曖昧、複数の解釈が可能 | ユーザーに確認 |

### 2. 継続時の進捗確認
フロー継続の場合、以下を確認：
- 最新の成果物（要件定義書/ADR/Design Doc/作業計画書/タスク）
- 現在のフェーズ位置（要件/設計/計画/実装/品質保証）
- sub-agents.mdの該当フローで次のステップを特定

### 3. 次のアクション実行

**sub-agents.mdを必ず参照**：
- **Figma統合判定**: ユーザー指示またはNotion情報にFigma URL（https://www.figma.com/...）、デザイン仕様書言及、「Figmaデザインに従う」等が含まれる場合 → Figma統合フロー適用
- 規模別フロー（大規模/中規模/小規模）を確認
- 自律実行モードの条件を確認
- 必須停止ポイントを認識
- フローに定義された次のサブエージェントを呼び出す

## 📋 sub-agents.md準拠の実行

**実行前チェック（必須）**：
- [ ] sub-agents.mdの該当フローを確認した
- [ ] 現在の進捗位置を特定した
- [ ] 次のステップを明確にした
- [ ] 停止ポイントを認識した
- [ ] タスク実行後の品質サイクルを理解した

**フロー逸脱禁止**: sub-agents.mdに定義されたフローから外れることは禁止。

## 🎯 オーケストレーターとしての必須責務

### タスク実行時の品質サイクル管理
**絶対的ルール**：task-executor実行後は必ず以下を実行
1. git commit実行（Bashツール使用）
2. 次タスクの実行または完了報告

**省略禁止**：このサイクルを省略した場合、実装品質を保証できない

### テスト情報の伝達
acceptance-test-generator実行後、work-planner呼び出し時には以下を伝達：
- 生成された統合テストファイルパス
- 生成されたE2Eテストファイルパス
- 統合テストは実装と同時、E2Eは全実装後に実行する旨の明示

## 責務境界

**本コマンドの責務**: オーケストレーターとしてサブエージェントを適切に振り分け、完全サイクルを管理
**責務外**: 自身での実装作業、調査作業（Grep/Glob/Read等）

---

## 実装専門原則（オーケストレーター・実装エージェント向け）

### 🚨 最重要原則：調査OK、実装STOP

**すべてのEdit/Write/MultiEditツール使用前にユーザー承認が必須**

理由：ユーザーの意図と異なる実装を防ぎ、正しい方向性を確保するため

### 実装実行プロセス

#### 実行フロー（必須手順）
1. **TodoWriteでタスク分解** → なければ実装ステップに進めない
2. **Edit/Write/MultiEdit使用** → ユーザー承認が必須
3. **実装実行** → 品質チェックエラーは完了条件を満たさない
4. **ファイル数カウント** → 閾値超過で自動停止

#### TodoWriteと実装の統合
**実行ルール**：
- TodoWriteなしでEditツール使用: ルール違反として停止
  理由：タスク管理なしでは進捗追跡と品質保証ができないため

#### 実装前提条件
1. **TodoWriteのタスク** → in_progressステータスが存在すること
2. **ユーザー承認記録** → Edit/Write前に明示的承認があること
3. **品質チェック結果** → エラー0でなければ完了不可

#### 禁止事項（実装時）
- **TodoWriteなしのEdit使用** → ルール違反
- **承認なしEdit/Write/MultiEdit** → 承認待ちに移行
- **品質エラー残存での完了宣言** → 完了条件を満たさない

### 実装時の行動制御（失敗防止）

#### 自動停止トリガー（必ず停止）
- **5ファイル以上の変更検出**：即座停止、影響範囲をユーザーに報告
  理由：大規模変更は事前計画とレビューが必要なため
- **3ファイル編集完了**: TodoWriteの更新を強制（更新しないと次のEditツール使用不可）
  理由：進捗確認と方向性の再確認が必要なため

#### エラー修正衝動対処
1. エラー発見 → **一時停止**
2. 根本原因分析（なぜ？を5回繰り返して真因を特定）
3. 対処計画提示
4. ユーザー承認後に修正

#### 集中時のルール無視防止
**測定可能な強制停止基準**：
- **連続エラー修正2回目**: 一時停止し、根本原因分析を実施
- **Editツール5回使用**: 影響範囲レポートの作成を強制
- **同一ファイル3回編集**: リファクタリング検討の強制停止

### 品質チェックの責務分担

#### 各タスク実行時
task-executorがtasksファイルの完了条件に従って基本品質チェック実行：
- TypeScript strict mode: エラー0件
- Biome lint: エラー0件
- 追加したテスト: すべてパス

#### 最終タスク実行時
quality-fixerがプロジェクト全体品質チェック実行：
- オーケストレーターが最終Phaseの最終タスクで呼び出し
- プロジェクト全体の統合品質を保証

## 同期ポイント（CHECKPOINT）

### CHECKPOINT 1: 設計完了時

**タイミング**: technical-designer完了後、work-planner実行前

**実行内容**:
1. notion-client(create_review_task)を呼び出し:
   - reviewType: design
   - storyId: {STORY_ID}
   - data: 設計ドキュメント情報（requirements.md, ADR, design.md）

2. notion-client(update_story_status)を呼び出し:
   - storyId: {STORY_ID}
   - status: 設計レビュー待ち

**目的**: 設計フェーズ完了をNotionに記録し、レビュータスクを作成

### CHECKPOINT 2: 実装完了時

**タイミング**: 最終task-executor完了後、quality-fixer実行後

**実行内容**:
1. notion-client(create_review_task)を呼び出し:
   - reviewType: implementation
   - storyId: {STORY_ID}
   - data: 実装情報（PRリンク、変更ファイル数、テスト結果）

2. notion-client(update_story_status)を呼び出し:
   - storyId: {STORY_ID}
   - status: 実装レビュー待ち

3. meta.jsonを更新:
   - github_pr_url: PRのURL
   - github_branch: ブランチ名

**目的**: 実装フェーズ完了をNotionに記録し、レビュータスクを作成